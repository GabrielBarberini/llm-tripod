# ==============================================================================
# TRIPOD FRAMEWORK CONFIGURATION - IOT DOMAIN
# ==============================================================================
experiment_name: "iot_thermal_control_v1"
output_dir: "../experiments/iot_v1"  # Persist outside the repo by default.

# ------------------------------------------------------------------------------
# LEG 1: TRAINING MANAGEMENT (LoRA / PEFT)
# ------------------------------------------------------------------------------
training:
  enabled: true
  base_model: "meta-llama/Meta-Llama-3-8B-Instruct"
  dataset_path: "s3://iot-datalake/training/thermal_logs_2024.parquet"
  adapter_output_dir: "../artifacts/models/adapters/thermal_v1"

  # Fine-Grained LoRA Config
  lora_config:
    r: 16
    alpha: 32
    dropout: 0.05
    target_modules: ["q_proj", "v_proj"]
    bias: "none"
    task_type: "CAUSAL_LM"

  # Hyperparameters
  hyperparameters:
    batch_size: 32
    micro_batch_size: 4
    learning_rate: 3.0e-4
    num_epochs: 3
    quantization: "4bit" # 4bit, 8bit, or none
    gradient_accumulation_steps: 4
    logging_steps: 10

# ------------------------------------------------------------------------------
# LEG 2: RETRIEVAL MANAGEMENT (RAFT + RAG)
# ------------------------------------------------------------------------------
rag:
  enabled: true
  vector_db_type: "chromadb" # chromadb, pinecone, faiss
  vector_db_path: "./training_data/vectordb"
  collection_name: "iot_history_logs"

  # Ingestion Config
  ingestion:
    embedding_model: "sentence-transformers/all-MiniLM-L6-v2"

  # Retrieval Config (The knobs you tweak)
  retrieval:
    strategy: "similarity" # similarity, mmr, hybrid
    top_k: 5

raft:
  enabled: true
  vector_db_type: "chromadb" # chromadb, pinecone, faiss
  vector_db_path: "./training_data/vectordb"
  collection_name: "iot_history_logs"

  # Ingestion Config
  ingestion:
    embedding_model: "sentence-transformers/all-MiniLM-L6-v2"

  # Retrieval Config (The knobs you tweak)
  retrieval:
    strategy: "similarity" # similarity, mmr, hybrid
    top_k: 5

# ------------------------------------------------------------------------------
# LEG 3: PROMPT ENGINEERING (Instructions)
# ------------------------------------------------------------------------------
prompting:
  template_id: "cot_engineering_v2"
  backend: "dspy"
  dspy:
    include_user_prompt: true
    chain_of_thought: false
    output_field: "response"
    output_desc: "JSON output matching the schema."

  # Dynamic Template using Jinja2 syntax
  system_prompt: |
    You are an expert Industrial IoT Controller for domain: {{ domain }}.
    Your goal is to maintain system stability while optimizing power.
    Adhere to the following JSON output schema:
    {
      "action": "string",
      "parameters": {"fan_speed": int, "voltage_bias": float},
      "reasoning": "string"
    }

  user_prompt_structure: |
    ### HISTORY (Context):
    {{ rag_context }}

    ### CURRENT SENSOR STATE:
    {{ sensor_data }}

    ### INSTRUCTION:
    Analyze the history and current state. Determine the optimal configuration.

  # Few-Shot Management
  few_shot:
    enabled: true
    source_file: "./configs/few_shot_examples.json"
    selection_strategy: "semantic_similarity" # dynamic selection based on input
    count: 3

# ------------------------------------------------------------------------------
# EVALUATION (The Feedback Loop)
# ------------------------------------------------------------------------------
evaluation:
  test_set_path: "./training_data/test_set_golden.jsonl"
  metrics:
    - "json_validity"
    - "action_match_accuracy"
    - "reasoning_similarity"
