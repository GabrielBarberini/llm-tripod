experiment_name: "smoke_e2e_v1"
output_dir: "./training_data/smoke/out"

training:
  enabled: true
  base_model: "TinyLlama/TinyLlama-1.1B-Chat-v1.0"
  dataset_path: "./training_data/smoke/train_text_no_raft.jsonl"
  adapter_output_dir: "./training_data/smoke/adapter"
  lora_config:
    r: 8
    alpha: 16
    dropout: 0.05
    target_modules: ["q_proj", "v_proj", "k_proj", "o_proj"]
  hyperparameters:
    # SFT format: tests/smoke_e2e.py appends `ASSISTANT:` before the JSON response.
    response_marker: "\nASSISTANT:\n"
    mask_prompt: true

    # GPU-friendly defaults (RTX 2000 Ada 16GB): safe and reasonably fast.
    micro_batch_size: 1
    gradient_accumulation_steps: 8
    learning_rate: 2.0e-4
    num_epochs: 2
    quantization: "4bit"
    max_seq_length: 512
    logging_steps: 10
    bf16: true
    optim: "paged_adamw_8bit"
    lr_scheduler_type: "cosine"
    warmup_ratio: 0.03

rag:
  enabled: true
  vector_db_type: "local"
  vector_db_path: "./training_data/smoke/vectordb"
  collection_name: "smoke"
  ingestion:
    embedding_model: "sentence-transformers/all-MiniLM-L6-v2"
  retrieval:
    strategy: "similarity"
    top_k: 3

raft:
  enabled: true
  vector_db_type: "local"
  vector_db_path: "./training_data/smoke/vectordb"
  collection_name: "smoke"
  ingestion:
    embedding_model: "sentence-transformers/all-MiniLM-L6-v2"
  retrieval:
    strategy: "similarity"
    top_k: 3

prompting:
  template_id: "smoke_json_controller_v1"
  backend: "raw"
  system_prompt: |
    You are an expert Industrial IoT Controller for domain: {{ domain }}.
    Use the provided HISTORY context (policies/heuristics) to choose the correct action.
    Output ONLY valid JSON with keys: action, parameters, reasoning.
    Allowed actions: "maintain", "schedule_maintenance", "set_thermal_profile".
    parameters MUST include both: fan_speed (int), voltage_bias (float).
    Do NOT wrap JSON in markdown fences. Do NOT output extra keys.
  user_prompt_structure: |
    ### HISTORY:
    {{ rag_context }}

    ### SENSOR:
    {{ sensor_data }}

    ### INSTRUCTION:
    Use the policy numbers from HISTORY when action is set_thermal_profile.
    If vibration >= 1.0, prefer schedule_maintenance.
    Output JSON now.

evaluation:
  test_set_path: "./training_data/smoke/test.jsonl"
  metrics:
    - "action_match_accuracy"
  generation:
    top_p: 1.0
    do_sample: false
